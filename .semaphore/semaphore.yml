version: v1.0
name: First pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
    
blocks:
	- name: Setup
    task:
    	jobs:
      	- name: bundle
        	commands:
        	# Checkout code from Git repository. This step is mandatory if the
        	# job is to work with your code.
        	# Optionally you may use --use-cache flag to avoid roundtrip to
        	# remote repository.
        	# See https://docs.semaphoreci.com/reference/toolbox-reference/#checkout
        	- checkout
        	# Restore dependencies from cache.
        	# Read about caching: https://docs.semaphoreci.com/essentials/caching-dependencies-and-directories/
        	- cache restore
        	# Set Ruby version:
        	- sem-version ruby 2.6.0
        	- bundle install
        	# Store the latest version of dependencies in cache,
        	# to be used in next blocks and future workflows:
        	- cache store
          
  - name: Lint
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: Check style
          commands:
            - checkout
            - cache restore
            - sem-version ruby 2.7.2
            - bundle install
            - bundle exec rubocop
            
  - name: Unit tests
    task:
      prologue:
        commands:
          - checkout
          - cache restore
          - sem-service start postgres
          - sem-version ruby 2.7.2
          - bundle install
          - bundle exec rake db:setup
      jobs:
        - name: Rspec tests
          commands:
            - bundle exec rspec
            
